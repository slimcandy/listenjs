{"version":3,"file":"listenjs.js","sources":["../src/events.ts","../src/types.ts","../src/destroy-dom.ts","../src/dispatcher.ts","../src/set-prop.ts","../src/utils/props.ts","../src/mount-dom.ts","../src/utils/arrays.ts","../src/utils/objects.ts","../src/utils/strings.ts","../src/vnode-equal.ts","../src/patch-dom.ts","../src/create-app.ts","../src/create-element.ts"],"sourcesContent":["import type { FiberInstance } from \"./fiber\";\nimport type { DomEventMap, DOMEventName, DOMEmitGenerator } from \"./types\";\n\ntype DOMEventWithContext = (event: Event) => void;\ntype DOMEventListener = Partial<Record<DOMEventName, DOMEventWithContext>>;\n\nfunction attachEventListener(\n  domEventName: DOMEventName,\n  emitGenerator: DOMEmitGenerator,\n  domElement: HTMLElement,\n  parentFiberInstance: FiberInstance | null = null\n) {\n  function boundContextToDOMEvent(...args: [Event]) {\n    if (parentFiberInstance) {\n      emitGenerator.apply(parentFiberInstance, args);\n    } else {\n      emitGenerator(...args);\n    }\n  }\n\n  domElement.addEventListener(domEventName, boundContextToDOMEvent);\n\n  return boundContextToDOMEvent;\n}\n\nfunction attachEventListeners(\n  domEventMap: DomEventMap = {},\n  domElement: HTMLElement,\n  parentFiberInstance: FiberInstance | null = null\n): DOMEventListener {\n  const attachedDOMEventListeners: DOMEventListener = {};\n\n  Object.entries(domEventMap).forEach(([domEventName, emitGenerator]) => {\n    const listener = attachEventListener(\n      domEventName as DOMEventName,\n      emitGenerator,\n      domElement,\n      parentFiberInstance\n    );\n    attachedDOMEventListeners[domEventName] = listener;\n  });\n\n  return attachedDOMEventListeners;\n}\n\nfunction removeEventListeners(\n  attachedDOMEventListeners: DOMEventListener = {},\n  domElement: HTMLElement\n) {\n  Object.entries(attachedDOMEventListeners).forEach(\n    ([domEventName, domEventWithContext]) => {\n      domElement.removeEventListener(domEventName, domEventWithContext);\n    }\n  );\n}\n\nexport {\n  attachEventListener,\n  attachEventListeners,\n  removeEventListeners,\n  type DOMEventListener,\n};\n","import type { Emit } from \"./create-app\";\nimport type { ActionPayload } from \"./dispatcher\";\nimport type { DOMEventListener } from \"./events\";\nimport type { FiberClass, FiberInstance } from \"./fiber\";\n\nenum VDOMType {\n  TEXT = Node.TEXT_NODE,\n  ELEMENT = Node.ELEMENT_NODE,\n  FRAGMENT = Node.DOCUMENT_FRAGMENT_NODE,\n  FIBER = \"FIBER\",\n}\n\nenum ARRAY_DIFF_OP {\n  ADD = \"add\",\n  REMOVE = \"remove\",\n  MOVE = \"move\",\n  NOOP = \"noop\",\n}\n\ninterface Attributes {\n  [key: string]: unknown; // For general string attributes like id, title, href, etc.\n}\n\ntype DOMEventName = keyof GlobalEventHandlersEventMap;\n/**\n * DOM Event\n * @returns Emit\n */\ntype DOMEmitGenerator = (event?: Event) => Emit;\ntype DomEventMap = Partial<Record<DOMEventName, DOMEmitGenerator>>;\n\ntype FiberEventName = string;\n/**\n * Fiber Event\n * @returns Emit\n */\ntype FiberEmitGenerator = (actionPayload?: ActionPayload) => Emit;\ntype FiberEventMap = Record<FiberEventName, FiberEmitGenerator>;\n\ntype DOMProps = Attributes & {\n  on?: DomEventMap;\n  class?: string | string[]; // CSS classes\n  style?: Record<string, string>; // Inline styles\n};\n\ntype FiberProps = Attributes & {\n  on?: FiberEventMap;\n};\n\n// Virtual DOM node types\ninterface TextVNode {\n  type: VDOMType.TEXT;\n  value: string;\n  domElement?: Text;\n}\n\ninterface BaseNode {\n  children: VNode[];\n  domElement?: HTMLElement;\n  listeners?: DOMEventListener;\n}\n\ninterface FiberVNode extends BaseNode {\n  props: FiberProps;\n  type: VDOMType.FIBER;\n  tag: FiberClass;\n  fiberInstance: FiberInstance;\n}\n\ninterface ElementVNode extends BaseNode {\n  props: DOMProps;\n  type: VDOMType.ELEMENT;\n  tag: string;\n}\n\ninterface FragmentVNode {\n  type: VDOMType.FRAGMENT;\n  children: VNode[];\n  domElement?: HTMLElement; // Parent node for fragment\n}\n\ntype VNode = TextVNode | ElementVNode | FiberVNode | FragmentVNode;\ntype VNodeChild = string | VNode; // Acceptable child types\ntype DomElement = Text | HTMLElement;\n\nexport {\n  VDOMType,\n  ARRAY_DIFF_OP,\n  type ElementVNode,\n  type FiberVNode,\n  type VNode,\n  type VNodeChild,\n  type FragmentVNode,\n  type Attributes,\n  type FiberEventMap,\n  type FiberEventName,\n  type FiberEmitGenerator,\n  type FiberProps,\n  type DOMProps,\n  type TextVNode,\n  type DomElement,\n  type DomEventMap,\n  type DOMEventName,\n  type DOMEmitGenerator,\n};\n","import { removeEventListeners } from \"./events\";\nimport {\n  VDOMType\n} from \"./types\";\n\nimport type {\n  ElementVNode,\n  FragmentVNode,\n  TextVNode,\n  VNode} from \"./types\";\n\nfunction destroyDOM(vNode: VNode) {\n  const { type } = vNode;\n\n  switch (type) {\n    case VDOMType.TEXT: {\n      removeTextNode(vNode);\n      break;\n    }\n    case VDOMType.ELEMENT: {\n      removeElementNode(vNode);\n      break;\n    }\n    case VDOMType.FRAGMENT: {\n      removeFragmentNodes(vNode);\n      break;\n    }\n    case VDOMType.FIBER: {\n      vNode.fiberInstance.unmount();\n      break;\n    }\n\n    default: {\n      throw new Error(\"Cannot destroy DOM of type: \", type);\n    }\n  }\n\n  delete vNode.domElement;\n}\n\nfunction removeTextNode(vNode: TextVNode) {\n  const { domElement } = vNode;\n  if (domElement) {\n    domElement.remove();\n  }\n}\n\nfunction removeElementNode(vNode: ElementVNode) {\n  const { domElement, children, listeners } = vNode;\n\n  if (!domElement) {return;}\n\n  domElement.remove();\n  children.forEach(destroyDOM);\n\n  if (listeners) {\n    removeEventListeners(listeners, domElement);\n    delete vNode.listeners;\n  }\n}\n\nfunction removeFragmentNodes(vNode: FragmentVNode) {\n  const { children } = vNode;\n  children.forEach(destroyDOM);\n}\n\nexport { destroyDOM };\n","type ActionName = string;\ntype ActionPayload = string | number | object;\ntype ReducerWithInjectedState = (payload?: ActionPayload) => void;\n\ntype AfterCommandHandler = () => void;\ntype UnsubscribeFunction = () => void;\n\nclass Dispatcher {\n  #actionSubscriptions: Map<string, ReducerWithInjectedState[]> = new Map();\n  #afterHandlers: AfterCommandHandler[] = [];\n\n  subscribe(\n    actionName: ActionName,\n    reducerWithInjectedState: ReducerWithInjectedState\n  ): UnsubscribeFunction {\n    if (!this.#actionSubscriptions.has(actionName)) {\n      this.#actionSubscriptions.set(actionName, []);\n    }\n\n    const reducers = this.#actionSubscriptions.get(actionName);\n    if (reducers?.includes(reducerWithInjectedState)) {\n      return () => {};\n    }\n    reducers?.push(reducerWithInjectedState);\n\n    return function unsubscribe() {\n      if (reducers) {\n        const index = reducers?.indexOf(reducerWithInjectedState);\n        reducers?.splice(index, 1);\n      }\n    };\n  }\n\n  afterEveryCommand(afterHandler: AfterCommandHandler) {\n    this.#afterHandlers.push(afterHandler);\n    return () => {\n      const index = this.#afterHandlers.indexOf(afterHandler);\n      this.#afterHandlers.splice(index, 1);\n    };\n  }\n\n  dispatch(actionName: ActionName, actionPayload?: ActionPayload) {\n    if (this.#actionSubscriptions.has(actionName)) {\n      this.#actionSubscriptions\n        .get(actionName)\n        ?.forEach((reducer) => reducer(actionPayload));\n    } else {\n      console.warn(`No handlers found for command: ${actionName}`);\n    }\n\n    this.#afterHandlers.forEach((afterHandler) => afterHandler());\n  }\n}\n\nexport {\n  Dispatcher,\n  type ActionName,\n  type ActionPayload,\n  type UnsubscribeFunction,\n};\n","import type { DOMProps, FiberProps } from \"./types\";\n\nfunction setProp(domElement: HTMLElement, props: DOMProps | FiberProps) {\n  const { class: className, style, ...restAttrs } = props;\n\n  if (typeof className === \"string\" || Array.isArray(className)) {\n    setClass(domElement, className);\n  }\n\n  if (style) {\n    Object.entries(style).forEach(([key, value]) => {\n      if (typeof value === \"string\") {\n        setStyle(domElement, key, value);\n      }\n    });\n  }\n\n  for (const [key, value] of Object.entries(restAttrs)) {\n    if (typeof value === \"string\") {\n      setValueForAttribute(domElement, key, value);\n    }\n  }\n}\n\nfunction setClass(domElement: HTMLElement, className: string | string[]) {\n  domElement.className = \"\";\n\n  if (typeof className === \"string\") {\n    domElement.className = className;\n  }\n\n  if (Array.isArray(className)) {\n    domElement.classList.add(...className);\n  }\n}\n\nfunction setStyle(domElement: HTMLElement, key: string, value: string) {\n  domElement.style[key] = value;\n}\n\nfunction removeStyle(domElement: HTMLElement, key: string) {\n  domElement.style[key] = null;\n}\n\nfunction setValueForAttribute(\n  domElement: HTMLElement,\n  key: string,\n  value: unknown\n) {\n  if (value == null) {\n    removeValueForAttribute(domElement, key);\n  } else if (key.startsWith(\"data-\")) {\n    domElement.setAttribute(key, String(value));\n  } else {\n    domElement[key] = value;\n  }\n}\n\nfunction removeValueForAttribute(domElement: HTMLElement, key: string) {\n  domElement[key] = null;\n  domElement.removeAttribute(key);\n}\n\nexport {\n  setProp,\n  setValueForAttribute,\n  removeValueForAttribute,\n  setStyle,\n  removeStyle,\n};\n","import type { ElementVNode, FiberVNode } from \"../types\";\n\nfunction extractPropsAndEvents<T extends FiberVNode | ElementVNode>(vNode: T) {\n  const { on: eventMap, ...props } = vNode.props;\n  delete props.key;\n\n  return { props, eventMap };\n}\n\nexport { extractPropsAndEvents };\n","import { attachEventListeners } from \"./events\";\nimport { setProp } from \"./set-prop\";\nimport {\n  VDOMType\n} from \"./types\";\nimport { extractPropsAndEvents } from \"./utils/props\";\n\nimport type { FiberInstance } from \"./fiber\";\nimport type {\n  DomElement,\n  ElementVNode,\n  FragmentVNode,\n  TextVNode,\n  VNode,\n  FiberVNode,\n  FiberEventMap} from \"./types\";\n\nfunction mountDOM(\n  vNode: VNode,\n  parentDOMElement: HTMLElement,\n  positionIndex: number | null = null,\n  parentFiberInstance: FiberInstance | null = null\n) {\n  if (parentDOMElement == undefined) {\n    throw new Error(`\n      \"Parent element is not defined: ${parentDOMElement}`);\n  }\n\n  switch (vNode.type) {\n    case VDOMType.TEXT:\n      createDOMElementFromTextNode(vNode, parentDOMElement, positionIndex);\n      break;\n    case VDOMType.ELEMENT:\n      createDOMElementFromElementNode(\n        vNode,\n        parentDOMElement,\n        positionIndex,\n        parentFiberInstance\n      );\n      break;\n    case VDOMType.FRAGMENT:\n      createDOMElementFromFragmentNode(\n        vNode,\n        parentDOMElement,\n        positionIndex,\n        parentFiberInstance\n      );\n      break;\n    case VDOMType.FIBER:\n      createDOMElementFromFiberNode(\n        vNode,\n        parentDOMElement,\n        positionIndex,\n        parentFiberInstance\n      );\n      break;\n    default:\n      throw new Error(`Unknown vNode type`);\n  }\n}\n\nfunction createDOMElementFromTextNode(\n  vNode: TextVNode,\n  parentDOMElement: HTMLElement,\n  positionIndex: number | null\n) {\n  const { value } = vNode;\n  const domTextNode = document.createTextNode(value);\n  vNode.domElement = domTextNode;\n\n  insertIntoDOM(domTextNode, parentDOMElement, positionIndex);\n}\n\nfunction createDOMElementFromFragmentNode(\n  vNode: FragmentVNode,\n  parentDOMElement: HTMLElement,\n  positionIndex: number | null,\n  parentFiberInstance: FiberInstance | null = null\n) {\n  const { children } = vNode;\n  vNode.domElement = parentDOMElement;\n\n  children.forEach((child, index) => {\n    mountDOM(\n      child,\n      parentDOMElement,\n      positionIndex ? positionIndex + index : null,\n      parentFiberInstance\n    );\n  });\n}\n\nfunction createDOMElementFromElementNode(\n  vNode: ElementVNode,\n  parentDOMElement: HTMLElement,\n  positionIndex: number | null,\n  parentFiberInstance: FiberInstance | null = null\n) {\n  const { tag, children } = vNode;\n\n  const domElement = document.createElement(tag);\n  setInitialProperties(domElement, vNode, parentFiberInstance);\n  vNode.domElement = domElement;\n\n  children.forEach((child) => {\n    mountDOM(child, domElement, null, parentFiberInstance);\n  });\n\n  return insertIntoDOM(domElement, parentDOMElement, positionIndex);\n}\n\nfunction createDOMElementFromFiberNode(\n  vNode: FiberVNode,\n  parentDOMElement: HTMLElement,\n  positionIndex: number | null,\n  parentFiberInstance: FiberInstance | null = null\n) {\n  const FiberClass = vNode.tag;\n  const { eventMap: fiberEventMap, props } = extractPropsAndEvents(vNode);\n  const fiberInstance = new FiberClass(\n    props,\n    fiberEventMap as FiberEventMap,\n    parentFiberInstance\n  );\n\n  fiberInstance.mount(parentDOMElement, positionIndex);\n  vNode.fiberInstance = fiberInstance;\n  vNode.domElement = fiberInstance.firstDOMElement;\n}\n\nfunction setInitialProperties(\n  domElement: HTMLElement,\n  vNode: ElementVNode,\n  parentFiberInstance: FiberInstance | null\n) {\n  const { eventMap, props } = extractPropsAndEvents(vNode);\n\n  if (eventMap) {\n    vNode.listeners = attachEventListeners(\n      eventMap,\n      domElement,\n      parentFiberInstance\n    );\n  }\n  setProp(domElement, props);\n}\n\nfunction insertIntoDOM(\n  domElement: DomElement,\n  parentDOMElement: Node,\n  positionIndex: number | null\n) {\n  if (positionIndex == null) {\n    return parentDOMElement.appendChild(domElement);\n  }\n\n  if (positionIndex < 0) {\n    throw new Error(\n      `Position Index must be positive integer, but got ${positionIndex}`\n    );\n  }\n\n  const children = parentDOMElement.childNodes;\n\n  if (positionIndex >= children.length) {\n    parentDOMElement.appendChild(domElement);\n  } else {\n    parentDOMElement.insertBefore(domElement, children[positionIndex]);\n  }\n}\n\nfunction extractChildren(vNode: VNode) {\n  if (\"children\" in vNode) {\n    const children: VNode[] = [];\n\n    for (const child of vNode.children) {\n      if (child.type === VDOMType.FRAGMENT) {\n        children.push(...extractChildren(child));\n      } else {\n        children.push(child);\n      }\n    }\n\n    return children;\n  }\n  return [];\n}\n\nexport { mountDOM, extractChildren };\n","import { ARRAY_DIFF_OP } from \"../types\";\n\nfunction withoutNulls<T>(children: (T | null | undefined)[]): T[] {\n  return children.filter((child) => child != null);\n}\n\nfunction arraysDiff<T>(\n  oldArray: T[],\n  newArray: T[]\n): {\n  added: T[];\n  removed: T[];\n} {\n  return {\n    added: newArray.filter((newArrayItem) => !oldArray.includes(newArrayItem)),\n    removed: oldArray.filter(\n      (oldArrayItem) => !newArray.includes(oldArrayItem)\n    ),\n  };\n}\n\ninterface Operation<T> {\n  op: ARRAY_DIFF_OP;\n  index: number;\n  item: T;\n}\n\ninterface NoopOperation<T> extends Operation<T> {\n  originalIndex: number;\n}\n\ninterface MoveOperation<T> extends Operation<T> {\n  originalIndex: number;\n  from: number;\n}\n\nclass ArrayWithOriginalIndices<T> {\n  #array: T[] = [];\n  #originalIndices: number[] = [];\n  #equalsFn: (a: T, b: T) => boolean;\n\n  constructor(array: T[], equalsFn: (a: T, b: T) => boolean) {\n    this.#array = [...array];\n    this.#originalIndices = array.map((_, index) => index);\n    this.#equalsFn = equalsFn;\n  }\n\n  get length() {\n    return this.#array.length;\n  }\n\n  originalIndexAt(index: number) {\n    return this.#originalIndices[index];\n  }\n\n  findIndexFrom(item: T, fromIndex: number) {\n    for (let index = fromIndex; index < this.length; index++) {\n      if (this.#equalsFn(item, this.#array[index])) {\n        return index;\n      }\n    }\n\n    return -1;\n  }\n\n  wasElementRemoved(index: number, newArray: T[]) {\n    if (index >= this.length) {\n      return false;\n    }\n\n    const item = this.#array[index];\n    const indexInNewArray = newArray.findIndex((newItem) =>\n      this.#equalsFn(item, newItem)\n    );\n\n    return indexInNewArray === -1;\n  }\n\n  wasElementTheSame(index: number, newArray: T[]) {\n    if (index >= this.length) {\n      return false;\n    }\n\n    const item = this.#array[index];\n    const newItem = newArray[index];\n\n    return this.#equalsFn(item, newItem);\n  }\n\n  wasElementAdded(item: T, fromIndex: number) {\n    return this.findIndexFrom(item, fromIndex) === -1;\n  }\n\n  removeItemAction(index: number): Operation<T> {\n    const operation: Operation<T> = {\n      op: ARRAY_DIFF_OP.REMOVE,\n      index,\n      item: this.#array[index],\n    };\n\n    this.#array.splice(index, 1);\n    this.#originalIndices.splice(index, 1);\n\n    return operation;\n  }\n\n  noopItemAction(index: number): NoopOperation<T> {\n    return {\n      op: ARRAY_DIFF_OP.NOOP,\n      originalIndex: this.originalIndexAt(index),\n      index,\n      item: this.#array[index],\n    };\n  }\n\n  addItemAction(item: T, index: number): Operation<T> {\n    const operation: Operation<T> = {\n      op: ARRAY_DIFF_OP.ADD,\n      index,\n      item,\n    };\n\n    this.#array.splice(index, 0, item);\n    this.#originalIndices.splice(index, 0, -1);\n\n    return operation;\n  }\n\n  moveItemAction(item: T, toIndex: number): MoveOperation<T> {\n    const fromIndex = this.findIndexFrom(item, toIndex);\n\n    const operation: MoveOperation<T> = {\n      op: ARRAY_DIFF_OP.MOVE,\n      originalIndex: this.originalIndexAt(fromIndex),\n      from: fromIndex,\n      index: toIndex,\n      item: this.#array[fromIndex],\n    };\n\n    const [_item] = this.#array.splice(fromIndex, 1);\n    this.#array.splice(toIndex, 0, _item);\n\n    const [originalIndex] = this.#originalIndices.splice(fromIndex, 1);\n    this.#originalIndices.splice(toIndex, 0, originalIndex);\n\n    return operation;\n  }\n\n  removeRestItems(index: number): Operation<T>[] {\n    const operations: Operation<T>[] = [];\n\n    while (this.length > index) {\n      operations.push(this.removeItemAction(index));\n    }\n\n    return operations;\n  }\n}\n\nfunction arraysDiffSequence<T>(\n  oldArray: T[],\n  newArray: T[],\n  equalsFn: (a: T, b: T) => boolean = (a, b) => a === b\n): Array<Operation<T> | NoopOperation<T> | MoveOperation<T>> {\n  const sequence: Array<Operation<T> | NoopOperation<T> | MoveOperation<T>> =\n    [];\n  const array = new ArrayWithOriginalIndices<T>(oldArray, equalsFn);\n\n  for (let index = 0; index < newArray.length; index++) {\n    if (array.wasElementRemoved(index, newArray)) {\n      sequence.push(array.removeItemAction(index));\n      index--;\n      continue;\n    }\n\n    if (array.wasElementTheSame(index, newArray)) {\n      sequence.push(array.noopItemAction(index));\n      continue;\n    }\n\n    const item = newArray[index];\n\n    if (array.wasElementAdded(item, index)) {\n      sequence.push(array.addItemAction(item, index));\n      continue;\n    }\n\n    sequence.push(array.moveItemAction(item, index));\n  }\n\n  sequence.push(...array.removeRestItems(newArray.length));\n\n  return sequence;\n}\n\nexport { withoutNulls, arraysDiff, arraysDiffSequence };\n","import type { DomEventMap, DOMEventName } from \"../types\";\n\nfunction objectsDiff(\n  oldObject: DomEventMap,\n  newObject: DomEventMap\n): {\n  added: DOMEventName[];\n  removed: DOMEventName[];\n  updated: DOMEventName[];\n} {\n  const oldKeys = Object.keys(oldObject) as DOMEventName[];\n  const newKeys = Object.keys(newObject) as DOMEventName[];\n\n  return {\n    added: newKeys.filter((newKey) => !(newKey in oldObject)),\n    removed: oldKeys.filter((oldKey) => !(oldKey in newObject)),\n    updated: newKeys.filter(\n      (newKey) => newKey in oldObject && oldObject[newKey] !== newObject[newKey]\n    ),\n  };\n}\n\nfunction hasOwnProperty(obj: object, prop: string) {\n  return Object.prototype.hasOwnProperty.call(obj, prop);\n}\n\nexport { objectsDiff, hasOwnProperty };\n","function isNotEmptyString(str: string) {\n  return str !== \"\";\n}\n\nfunction isNotBlankOrEmptyString(str: string) {\n  return isNotEmptyString(str.trim());\n}\n\nexport { isNotBlankOrEmptyString };\n","import { VDOMType } from \"./types\";\n\nimport type { VNode } from \"./types\";\n\nfunction areVNodesEqual(vNodeA: VNode, vNodeB: VNode) {\n  if (\n    vNodeA.type === vNodeB.type &&\n    vNodeA.type === VDOMType.ELEMENT &&\n    vNodeB.type === VDOMType.ELEMENT\n  ) {\n    const {\n      tag: tagA,\n      props: { key: keyA },\n    } = vNodeA;\n    const {\n      tag: tagB,\n      props: { key: keyB },\n    } = vNodeB;\n\n    return tagA === tagB && keyA === keyB;\n  }\n\n  if (\n    vNodeA.type === vNodeB.type &&\n    vNodeA.type === VDOMType.FIBER &&\n    vNodeB.type === VDOMType.FIBER\n  ) {\n    const {\n      tag: tagA,\n      props: { key: keyA },\n    } = vNodeA;\n    const {\n      tag: tagB,\n      props: { key: keyB },\n    } = vNodeB;\n\n    return tagA === tagB && keyA === keyB;\n  }\n\n  return false;\n}\n\nexport { areVNodesEqual };\n","import { destroyDOM } from \"./destroy-dom\";\nimport { attachEventListener } from \"./events\";\nimport { extractChildren, mountDOM } from \"./mount-dom\";\nimport {\n  removeStyle,\n  removeValueForAttribute,\n  setStyle,\n  setValueForAttribute,\n} from \"./set-prop\";\nimport {\n  ARRAY_DIFF_OP,\n  VDOMType\n} from \"./types\";\nimport { arraysDiff, arraysDiffSequence } from \"./utils/arrays\";\nimport { objectsDiff } from \"./utils/objects\";\nimport { extractPropsAndEvents } from \"./utils/props\";\nimport { isNotBlankOrEmptyString } from \"./utils/strings\";\nimport { areVNodesEqual } from \"./vnode-equal\";\n\nimport type { FiberInstance } from \"./fiber\";\nimport type {\n  Attributes,\n  DomElement,\n  ElementVNode,\n  TextVNode,\n  VNode,\n  FiberVNode,\n  DOMProps} from \"./types\";\n\nfunction patchDOM(\n  oldVNode: VNode,\n  newVNode: VNode,\n  parentDOMNode: HTMLElement,\n  parentFiberInstance: FiberInstance | null = null\n) {\n  if (!areVNodesEqual(oldVNode, newVNode)) {\n    const positionIndex = oldVNode.domElement\n      ? findIndexInParent(parentDOMNode, oldVNode.domElement)\n      : undefined;\n\n    destroyDOM(oldVNode);\n    mountDOM(newVNode, parentDOMNode, positionIndex, parentFiberInstance);\n\n    return newVNode;\n  }\n\n  newVNode.domElement = oldVNode.domElement;\n\n  switch (newVNode.type) {\n    case VDOMType.TEXT: {\n      if (oldVNode.type === VDOMType.TEXT) {\n        patchText(oldVNode, newVNode);\n      }\n\n      return newVNode;\n    }\n\n    case VDOMType.ELEMENT: {\n      if (oldVNode.type === VDOMType.ELEMENT) {\n        patchElement(oldVNode, newVNode, parentFiberInstance);\n      }\n      break;\n    }\n\n    case VDOMType.FIBER: {\n      if (oldVNode.type === VDOMType.FIBER) {\n        patchFiber(oldVNode, newVNode);\n      }\n      break;\n    }\n  }\n\n  patchChildren(oldVNode, newVNode, parentFiberInstance);\n\n  return newVNode;\n}\n\nfunction findIndexInParent(\n  parentDOMNode: Node,\n  domElement: DomElement\n): number | null {\n  const positionIndex = Array.from(parentDOMNode.childNodes).indexOf(\n    domElement\n  );\n\n  if (positionIndex < 0) {\n    return null;\n  }\n\n  return positionIndex;\n}\n\nfunction patchText(oldVNode: TextVNode, newVNode: TextVNode) {\n  if (!oldVNode.domElement) {\n    throw new Error(`Cannot find DOM Element for old vNode: ${oldVNode}`);\n  }\n\n  const domElement: Text = oldVNode.domElement;\n  const { value: oldText } = oldVNode;\n  const { value: newText } = newVNode;\n\n  if (oldText !== newText) {\n    domElement.nodeValue = newText;\n  }\n}\n\nfunction patchElement(\n  oldVNode: ElementVNode,\n  newVNode: ElementVNode,\n  parentFiber: FiberInstance | null = null\n) {\n  if (!oldVNode.domElement) {\n    throw new Error(`Cannot find DOM Element for old vNode: ${oldVNode}`);\n  }\n\n  const domElement: HTMLElement = oldVNode.domElement;\n  const {\n    class: oldClass,\n    style: oldStyle,\n    on: oldOnEvents,\n    ...oldRestAttributes\n  } = oldVNode.props;\n  const {\n    class: newClass,\n    style: newStyle,\n    on: newOnEvents,\n    ...newRestAttributes\n  } = newVNode.props;\n  const { listeners: oldListeners } = oldVNode;\n\n  patchAttributes(domElement, oldRestAttributes, newRestAttributes);\n  patchClasses(domElement, oldClass, newClass);\n  patchStyles(domElement, oldStyle, newStyle);\n  newVNode.listeners = patchEvents(\n    domElement,\n    oldListeners,\n    oldOnEvents,\n    newOnEvents,\n    parentFiber\n  );\n\n  function patchAttributes(\n    domElement: HTMLElement,\n    oldRestAttributes: Attributes,\n    newRestAttributes: Attributes\n  ) {\n    const { added, removed, updated } = objectsDiff(\n      oldRestAttributes,\n      newRestAttributes\n    );\n\n    for (const key of removed) {\n      removeValueForAttribute(domElement, key);\n    }\n\n    for (const key of added.concat(updated)) {\n      setValueForAttribute(domElement, key, newRestAttributes[key]);\n    }\n  }\n\n  function patchClasses(\n    domElement: HTMLElement,\n    oldClass: DOMProps[\"class\"],\n    newClass: DOMProps[\"class\"]\n  ) {\n    const oldClasses = toClassList(oldClass);\n    const newClasses = toClassList(newClass);\n\n    const { added, removed } = arraysDiff(oldClasses, newClasses);\n\n    if (removed.length > 0) {\n      domElement.classList.remove(...removed);\n    }\n    if (added.length > 0) {\n      domElement.classList.add(...added);\n    }\n\n    function toClassList(classes: DOMProps[\"class\"] = \"\") {\n      return Array.isArray(classes)\n        ? classes.filter(isNotBlankOrEmptyString)\n        : classes.split(/(\\s+)/).filter(isNotBlankOrEmptyString);\n    }\n  }\n\n  function patchStyles(\n    domElement: HTMLElement,\n    oldStyle: DOMProps[\"style\"] = {},\n    newStyle: DOMProps[\"style\"] = {}\n  ) {\n    const { added, removed, updated } = objectsDiff(oldStyle, newStyle);\n\n    for (const key of removed) {\n      removeStyle(domElement, key);\n    }\n\n    for (const key of added.concat(updated)) {\n      setStyle(domElement, key, newStyle[key]);\n    }\n  }\n\n  function patchEvents(\n    domElement: HTMLElement,\n    oldListeners: ElementVNode[\"listeners\"] = {},\n    oldOnEvents: DOMProps[\"on\"] = {},\n    newOnEvents: DOMProps[\"on\"] = {},\n    parentFiber: FiberInstance | null = null\n  ) {\n    const { added, removed, updated } = objectsDiff(oldOnEvents, newOnEvents);\n\n    for (const domEventName of removed.concat(updated)) {\n      if (oldListeners[domEventName]) {\n        domElement.removeEventListener(\n          domEventName,\n          oldListeners[domEventName]\n        );\n      }\n    }\n\n    const addedListeners: ElementVNode[\"listeners\"] = {};\n\n    for (const eventType of added.concat(updated)) {\n      if (newOnEvents[eventType]) {\n        addedListeners[eventType] = attachEventListener(\n          eventType,\n          newOnEvents[eventType],\n          domElement,\n          parentFiber\n        );\n      }\n    }\n\n    return addedListeners;\n  }\n}\n\nfunction patchFiber(oldVNode: FiberVNode, newVNode: FiberVNode) {\n  const { fiberInstance: oldFiberInstance } = oldVNode;\n  const { props: newProps } = extractPropsAndEvents(newVNode);\n\n  oldFiberInstance.updateProps(newProps);\n\n  newVNode.fiberInstance = oldFiberInstance;\n  newVNode.domElement = oldFiberInstance.firstDOMElement;\n}\n\nfunction patchChildren(\n  oldVNode: VNode,\n  newVNode: VNode,\n  parentFiber: FiberInstance | null = null\n) {\n  if (!oldVNode.domElement) {\n    throw new Error(`Cannot find DOM Element for old vNode: ${oldVNode}`);\n  }\n\n  const oldChildren = extractChildren(oldVNode);\n  const newChildren = extractChildren(newVNode);\n  const parentDomElement = oldVNode.domElement;\n\n  const diffSequence = arraysDiffSequence<VNode>(\n    oldChildren,\n    newChildren,\n    areVNodesEqual\n  );\n\n  for (const operation of diffSequence) {\n    const { index, item, op } = operation;\n    const offset = parentFiber?.offset ?? 0;\n\n    switch (op) {\n      case ARRAY_DIFF_OP.ADD: {\n        if (parentDomElement instanceof HTMLElement) {\n          mountDOM(item, parentDomElement, index + offset, parentFiber);\n        }\n        break;\n      }\n      case ARRAY_DIFF_OP.REMOVE: {\n        destroyDOM(item);\n        break;\n      }\n      case ARRAY_DIFF_OP.MOVE: {\n        if (parentDomElement instanceof HTMLElement) {\n          if (\"originalIndex\" in operation) {\n            const oldChild = oldChildren[operation.originalIndex + offset];\n            const newChild = newChildren[index];\n\n            if (!oldChild.domElement) {\n              throw new Error(\n                `Cannot find DOM Element for old vNode: ${oldVNode}`\n              );\n            }\n\n            const domElement = oldChild.domElement;\n            const domElementAtTargetPosition =\n              parentDomElement.childNodes[index];\n\n            parentDomElement.insertBefore(\n              domElement,\n              domElementAtTargetPosition\n            );\n            patchDOM(oldChild, newChild, parentDomElement, parentFiber);\n          }\n        }\n        break;\n      }\n      case ARRAY_DIFF_OP.NOOP: {\n        if (parentDomElement instanceof HTMLElement) {\n          if (\"originalIndex\" in operation) {\n            patchDOM(\n              oldChildren[operation.originalIndex],\n              newChildren[index],\n              parentDomElement,\n              parentFiber\n            );\n          }\n        }\n        break;\n      }\n    }\n  }\n}\n\nexport { patchDOM };\n","import { destroyDOM } from \"./destroy-dom\";\nimport { Dispatcher } from \"./dispatcher\";\nimport { mountDOM } from \"./mount-dom\";\nimport { patchDOM } from \"./patch-dom\";\n\nimport type { ActionName, ActionPayload} from \"./dispatcher\";\nimport type { VNode } from \"./types\";\n\ntype State = Record<string, string | number | object>;\ntype View = (state: State, emit: Emit) => VNode;\n\ntype Reducer = (state: State, actionPayload?: ActionPayload) => State;\ntype Reducers = Record<ActionName, Reducer>;\n\ntype Emit = (actionName: ActionName, actionPayload?: ActionPayload) => void;\n\nfunction createApp({\n  state,\n  view,\n  reducers = {},\n}: {\n  state: State;\n  view: View;\n  reducers: Reducers;\n}) {\n  let parentElement: HTMLElement | null = null;\n  let vDOMRootNode: VNode | null = null;\n\n  const dispatcher = new Dispatcher();\n  const subscriptions = [dispatcher.afterEveryCommand(renderApp)];\n\n  function emit(actionName: ActionName, actionPayload?: ActionPayload) {\n    dispatcher.dispatch(actionName, actionPayload);\n  }\n\n  for (const actionName in reducers) {\n    const reducer = reducers[actionName];\n\n    const subs = dispatcher.subscribe(\n      actionName,\n      function reducerWithInjectedState(actionPayload) {\n        state = reducer(state, actionPayload);\n      }\n    );\n    subscriptions.push(subs);\n  }\n\n  function renderApp() {\n    const nextVDOMRootNode = view(state, emit);\n\n    if (vDOMRootNode && parentElement) {\n      vDOMRootNode = patchDOM(vDOMRootNode, nextVDOMRootNode, parentElement);\n    }\n  }\n\n  return {\n    mount(_parentElement: HTMLElement | null) {\n      parentElement = _parentElement;\n      vDOMRootNode = view(state, emit);\n\n      if (vDOMRootNode && parentElement) {\n        mountDOM(vDOMRootNode, parentElement);\n      }\n    },\n    unmount() {\n      if (vDOMRootNode) {\n        destroyDOM(vDOMRootNode);\n      }\n      vDOMRootNode = null;\n      subscriptions.forEach((unsubscribe) => unsubscribe());\n    },\n  };\n}\n\nexport { createApp, type Emit };\n","import {\n  VDOMType\n} from \"./types\";\nimport { withoutNulls } from \"./utils/arrays\";\n\nimport type { FiberClass } from \"./fiber\";\nimport type {\n  ElementVNode,\n  VNode,\n  VNodeChild,\n  TextVNode,\n  FiberVNode,\n  DOMProps,\n  FiberProps} from \"./types\";\n\nfunction createElement(\n  tag: string | FiberClass,\n  props: DOMProps | FiberProps = {},\n  children: VNodeChild[] = []\n): ElementVNode | FiberVNode {\n  if (typeof tag === \"string\") {\n    return {\n      type: VDOMType.ELEMENT,\n      tag,\n      props,\n      children: mapTextNodes(withoutNulls(children)),\n    } as ElementVNode;\n  } else {\n    return {\n      type: VDOMType.FIBER,\n      tag,\n      props,\n      children: mapTextNodes(withoutNulls(children)),\n    } as FiberVNode;\n  }\n}\n\nfunction mapTextNodes(children: VNodeChild[]): VNode[] {\n  return children.map((child) =>\n    typeof child === \"string\" ? createTextElement(child) : child\n  );\n}\n\nfunction createTextElement(text: string): TextVNode {\n  return {\n    type: VDOMType.TEXT as const,\n    value: text,\n  };\n}\n\nexport { createElement };\n"],"names":["attachEventListener","domEventName","emitGenerator","domElement","parentFiberInstance","boundContextToDOMEvent","args","apply","addEventListener","VDOMType","ARRAY_DIFF_OP","destroyDOM","vNode","type","TEXT","remove","removeTextNode","ELEMENT","children","listeners","forEach","attachedDOMEventListeners","Object","entries","domEventWithContext","removeEventListener","removeEventListeners","removeElementNode","FRAGMENT","removeFragmentNodes","FIBER","fiberInstance","unmount","Error","Node","TEXT_NODE","ELEMENT_NODE","DOCUMENT_FRAGMENT_NODE","Dispatcher","actionSubscriptions","Map","afterHandlers","subscribe","actionName","reducerWithInjectedState","this","has","set","reducers","get","includes","push","index","indexOf","splice","afterEveryCommand","afterHandler","dispatch","actionPayload","reducer","console","warn","setProp","props","class","className","style","restAttrs","Array","isArray","classList","add","setClass","key","value","setStyle","setValueForAttribute","removeStyle","removeValueForAttribute","startsWith","setAttribute","String","removeAttribute","extractPropsAndEvents","on","eventMap","mountDOM","parentDOMElement","positionIndex","undefined","domTextNode","document","createTextNode","insertIntoDOM","createDOMElementFromTextNode","tag","createElement","domEventMap","listener","attachEventListeners","setInitialProperties","child","createDOMElementFromElementNode","createDOMElementFromFragmentNode","FiberClass","fiberEventMap","mount","firstDOMElement","createDOMElementFromFiberNode","appendChild","childNodes","length","insertBefore","extractChildren","withoutNulls","filter","ArrayWithOriginalIndices","array","originalIndices","equalsFn","constructor","map","_","originalIndexAt","findIndexFrom","item","fromIndex","wasElementRemoved","newArray","findIndex","newItem","wasElementTheSame","wasElementAdded","removeItemAction","operation","op","REMOVE","noopItemAction","NOOP","originalIndex","addItemAction","ADD","moveItemAction","toIndex","MOVE","from","_item","removeRestItems","operations","objectsDiff","oldObject","newObject","oldKeys","keys","newKeys","added","newKey","removed","oldKey","updated","isNotBlankOrEmptyString","str","isNotEmptyString","trim","areVNodesEqual","vNodeA","vNodeB","tagA","keyA","tagB","keyB","patchDOM","oldVNode","newVNode","parentDOMNode","findIndexInParent","oldText","newText","nodeValue","patchText","parentFiber","oldClass","oldStyle","oldOnEvents","oldRestAttributes","newClass","newStyle","newOnEvents","newRestAttributes","oldListeners","patchAttributes","concat","patchClasses","oldClasses","toClassList","newClasses","oldArray","newArrayItem","oldArrayItem","classes","split","patchStyles","patchEvents","addedListeners","eventType","patchElement","oldFiberInstance","newProps","updateProps","patchFiber","oldChildren","newChildren","parentDomElement","diffSequence","a","b","sequence","arraysDiffSequence","offset","HTMLElement","oldChild","newChild","domElementAtTargetPosition","patchChildren","createApp","state","view","parentElement","vDOMRootNode","dispatcher","subscriptions","nextVDOMRootNode","emit","subs","_parentElement","unsubscribe","mapTextNodes","text"],"mappings":"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"}