var e,t;function n(e){return e.filter(e=>null!=e)}!function(e){e[e.TEXT=Node.TEXT_NODE]="TEXT",e[e.ELEMENT=Node.ELEMENT_NODE]="ELEMENT",e[e.FRAGMENT=Node.DOCUMENT_FRAGMENT_NODE]="FRAGMENT",e.FIBER="FIBER"}(e||(e={})),function(e){e.ADD="add",e.REMOVE="remove",e.MOVE="move",e.NOOP="noop"}(t||(t={}));class r{#e=[];#t=[];#n;constructor(e,t){this.#e=[...e],this.#t=e.map((e,t)=>t),this.#n=t}get length(){return this.#e.length}originalIndexAt(e){return this.#t[e]}findIndexFrom(e,t){for(let n=t;n<this.length;n++)if(this.#n(e,this.#e[n]))return n;return-1}wasElementRemoved(e,t){if(e>=this.length)return!1;const n=this.#e[e];return-1===t.findIndex(e=>this.#n(n,e))}wasElementTheSame(e,t){if(e>=this.length)return!1;const n=this.#e[e],r=t[e];return this.#n(n,r)}wasElementAdded(e,t){return-1===this.findIndexFrom(e,t)}removeItemAction(e){const n={op:t.REMOVE,index:e,item:this.#e[e]};return this.#e.splice(e,1),this.#t.splice(e,1),n}noopItemAction(e){return{op:t.NOOP,originalIndex:this.originalIndexAt(e),index:e,item:this.#e[e]}}addItemAction(e,n){const r={op:t.ADD,index:n,item:e};return this.#e.splice(n,0,e),this.#t.splice(n,0,-1),r}moveItemAction(e,n){const r=this.findIndexFrom(e,n),o={op:t.MOVE,originalIndex:this.originalIndexAt(r),from:r,index:n,item:this.#e[r]},[i]=this.#e.splice(r,1);this.#e.splice(n,0,i);const[s]=this.#t.splice(r,1);return this.#t.splice(n,0,s),o}removeRestItems(e){const t=[];for(;this.length>e;)t.push(this.removeItemAction(e));return t}}function o(t,r={},o=[]){return"string"==typeof t?{type:e.ELEMENT,tag:t,props:r,children:i(n(o))}:{type:e.FIBER,tag:t,props:r,children:i(n(o))}}function i(t){return t.map(t=>{return"string"==typeof t?(n=t,{type:e.TEXT,value:n}):t;var n})}function s(e,t,n,r=null){function o(...e){r?t.apply(r,e):t(...e)}return n.addEventListener(e,o),o}let c=!1;const l=[];function a(e){l.push(e),function(){if(c)return;c=!0,queueMicrotask(d)}()}function d(){for(;l.length>0;){const e=l.shift();if(!e)return;const t=e();Promise.resolve(t).then(()=>{},e=>{console.error(`[scheduler]: ${e}`)})}c=!1}function u(t){const{type:n}=t;switch(n){case e.TEXT:!function(e){const{domElement:t}=e;t&&t.remove()}(t);break;case e.ELEMENT:!function(e){const{domElement:t,children:n,listeners:r}=e;if(!t)return;t.remove(),n.forEach(u),r&&(!function(e={},t){Object.entries(e).forEach(([e,n])=>{t.removeEventListener(e,n)})}(r,t),delete e.listeners)}(t);break;case e.FRAGMENT:!function(e){const{children:t}=e;t.forEach(u)}(t);break;case e.FIBER:t.fiberInstance.unmount(),a(()=>t.fiberInstance.onUnmounted());break;default:throw new Error("Cannot destroy DOM of type: ",n)}delete t.domElement}function f(e,t){const{class:n,style:r,...o}=t;("string"==typeof n||Array.isArray(n))&&function(e,t){e.className="","string"==typeof t&&(e.className=t);Array.isArray(t)&&e.classList.add(...t)}(e,n),r&&Object.entries(r).forEach(([t,n])=>{"string"==typeof n&&h(e,t,n)});for(const[t,n]of Object.entries(o))"string"==typeof n&&E(e,t,n)}function h(e,t,n){e.style[t]=n}function m(e,t){e.style[t]=null}function E(e,t,n){null==n?p(e,t):t.startsWith("data-")?e.setAttribute(t,String(n)):e[t]=n}function p(e,t){e[t]=null,e.removeAttribute(t)}function y(e){const{on:t,...n}=e.props;return delete n.key,{props:n,eventMap:t}}function v(t,n,r=null,o=null){if(null==n)throw new Error(`\n      "Parent element is not defined: ${n}`);switch(t.type){case e.TEXT:!function(e,t,n){const{value:r}=e,o=document.createTextNode(r);e.domElement=o,b(o,t,n)}(t,n,r);break;case e.ELEMENT:!function(e,t,n,r=null){const{tag:o,children:i}=e,c=document.createElement(o);(function(e,t,n){const{eventMap:r,props:o}=y(t);r&&(t.listeners=function(e={},t,n=null){const r={};return Object.entries(e).forEach(([e,o])=>{const i=s(e,o,t,n);r[e]=i}),r}(r,e,n));f(e,o)})(c,e,r),e.domElement=c,i.forEach(e=>{v(e,c,null,r)}),b(c,t,n)}(t,n,r,o);break;case e.FRAGMENT:!function(e,t,n,r=null){const{children:o}=e;e.domElement=t,o.forEach((e,o)=>{v(e,t,n?n+o:null,r)})}(t,n,r,o);break;case e.FIBER:!function(e,t,n,r=null){const o=e.tag,{eventMap:i,props:s}=y(e),c=new o(s,i,r);c.mount(t,n),e.fiberInstance=c,e.domElement=c.firstDOMElement}(t,n,r,o),a(()=>t.fiberInstance.onMounted());break;default:throw new Error("Unknown vNode type")}}function b(e,t,n){if(null==n)return t.appendChild(e);if(n<0)throw new Error(`Position Index must be positive integer, but got ${n}`);const r=t.childNodes;n>=r.length?t.appendChild(e):t.insertBefore(e,r[n])}function N(t){if("children"in t){const n=[];for(const r of t.children)r.type===e.FRAGMENT?n.push(...N(r)):n.push(r);return n}return[]}function M(e,t={}){let n,r=!1,i=null;return{mount(s){if(r)throw new Error("App is already mounted");n=s,i=o(e,t),n&&v(i,n),r=!0},unmount(){if(!r)throw new Error("App is not even mounted");if(!i)throw new Error("There is not even root virtual node");u(i),n=null,r=!1,i=null}}}class w{#r=new Map;#o=[];subscribe(e,t){this.#r.has(e)||this.#r.set(e,[]);const n=this.#r.get(e);return n?.includes(t)?()=>{}:(n?.push(t),function(){if(n){const e=n?.indexOf(t);n?.splice(e,1)}})}afterEveryCommand(e){return this.#o.push(e),()=>{const t=this.#o.indexOf(e);this.#o.splice(t,1)}}dispatch(e,t){this.#r.has(e)?this.#r.get(e)?.forEach(e=>e(t)):console.warn(`No handlers found for command: ${e}`),this.#o.forEach(e=>e())}}function I(e,t){const n=Object.keys(e),r=Object.keys(t);return{added:r.filter(t=>!(t in e)),removed:n.filter(e=>!(e in t)),updated:r.filter(n=>n in e&&e[n]!==t[n])}}function g(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function T(e){return function(e){return""!==e}(e.trim())}function O(t,n){if(t.type===n.type&&t.type===e.ELEMENT&&n.type===e.ELEMENT){const{tag:e,props:{key:r}}=t,{tag:o,props:{key:i}}=n;return e===o&&r===i}if(t.type===n.type&&t.type===e.FIBER&&n.type===e.FIBER){const{tag:e,props:{key:r}}=t,{tag:o,props:{key:i}}=n;return e===o&&r===i}return!1}function A(n,o,i,c=null){if(!O(n,o)){const e=n.domElement?function(e,t){const n=Array.from(e.childNodes).indexOf(t);if(n<0)return null;return n}(i,n.domElement):void 0;return u(n),v(o,i,e,c),o}switch(o.domElement=n.domElement,o.type){case e.TEXT:return n.type===e.TEXT&&function(e,t){if(!e.domElement)throw new Error(`Cannot find DOM Element for old vNode: ${e}`);const n=e.domElement,{value:r}=e,{value:o}=t;r!==o&&(n.nodeValue=o)}(n,o),o;case e.ELEMENT:n.type===e.ELEMENT&&function(e,t,n=null){if(!e.domElement)throw new Error(`Cannot find DOM Element for old vNode: ${e}`);if(!(e.domElement instanceof HTMLElement))throw new Error("patchElement was called with a non-HTMLElement.");const r=e.domElement,{class:o,style:i,on:c,...l}=e.props,{class:a,style:d,on:u,...f}=t.props,{listeners:y}=e;function v(e,t,n){const{added:r,removed:o,updated:i}=I(t,n);for(const t of o)p(e,t);for(const t of r.concat(i))E(e,t,n[t])}function b(e,t,n){const r=a(t),o=a(n),{added:i,removed:s}=(c=r,{added:(l=o).filter(e=>!c.includes(e)),removed:c.filter(e=>!l.includes(e))});var c,l;function a(e=""){return Array.isArray(e)?e.filter(T):e.split(/(\s+)/).filter(T)}s.length>0&&e.classList.remove(...s),i.length>0&&e.classList.add(...i)}function N(e,t={},n={}){const{added:r,removed:o,updated:i}=I(t,n);for(const t of o)m(e,t);for(const t of r.concat(i))h(e,t,n[t])}function M(e,t={},n={},r={},o=null){const{added:i,removed:c,updated:l}=I(n,r);for(const n of c.concat(l))t[n]&&e.removeEventListener(n,t[n]);const a={};for(const t of i.concat(l))r[t]&&(a[t]=s(t,r[t],e,o));return a}v(r,l,f),b(r,o,a),N(r,i,d),t.listeners=M(r,y,c,u,n)}(n,o,c);break;case e.FIBER:n.type===e.FIBER&&function(e,t){const{fiberInstance:n}=e,{props:r}=y(t);n.updateProps(r),t.fiberInstance=n,t.domElement=n.firstDOMElement}(n,o)}return function(e,n,o=null){if(!e.domElement)throw new Error(`Cannot find DOM Element for old vNode: ${e}`);const i=N(e),s=N(n),c=e.domElement,l=function(e,t,n=(e,t)=>e===t){const o=[],i=new r(e,n);for(let e=0;e<t.length;e++){if(i.wasElementRemoved(e,t)){o.push(i.removeItemAction(e)),e--;continue}if(i.wasElementTheSame(e,t)){o.push(i.noopItemAction(e));continue}const n=t[e];i.wasElementAdded(n,e)?o.push(i.addItemAction(n,e)):o.push(i.moveItemAction(n,e))}return o.push(...i.removeRestItems(t.length)),o}(i,s,O);for(const n of l){const{index:r,item:l,op:a}=n,d=o?.offset??0;switch(a){case t.ADD:c instanceof HTMLElement&&v(l,c,r+d,o);break;case t.REMOVE:u(l);break;case t.MOVE:if(c instanceof HTMLElement&&"originalIndex"in n){const t=i[n.originalIndex+d],l=s[r];if(!t.domElement)throw new Error(`Cannot find DOM Element for old vNode: ${e}`);const a=t.domElement,u=c.childNodes[r];c.insertBefore(a,u),A(t,l,c,o)}break;case t.NOOP:c instanceof HTMLElement&&"originalIndex"in n&&A(i[n.originalIndex],s[r],c,o)}}}(n,o,c),o}function F(){}function L({render:t,state:n,onMounted:r=F,onUnmounted:o=F,...i}){class s{#i=!1;#s;#c;#l;#a;#d=new w;#u;props;state;constructor(e={},t={},r=null){this.props=e,this.state=n?n(e):{},this.#l=t,this.#a=r}get domElements(){return null==this.#s?[]:this.#s.type===e.FRAGMENT?N(this.#s).flatMap(t=>t.type===e.FIBER?t.fiberInstance.domElements:t.domElement?[t.domElement]:[]):this.#s.domElement?[this.#s.domElement]:[]}get firstDOMElement(){return this.domElements[0]}get offset(){return this.#c&&this.firstDOMElement&&this.#s?.type===e.FRAGMENT?Array.from(this.#c?.childNodes).indexOf(this.firstDOMElement):0}render(){return t.call(this)}emit(e,t){this.#d.dispatch(e,t)}updateProps(e){this.props={...this.props,...e},this.#f()}updateState(e){this.state={...this.state,...e},this.#f()}onMounted(){return Promise.resolve(r.call(this))}onUnmounted(){return Promise.resolve(o.call(this))}mount(e,t=null){if(this.#i)throw new Error("Fiber is already mounted");this.#s=this.render(),this.#s&&v(this.#s,e,t,this),this.#h(),this.#c=e,this.#i=!0}unmount(){if(!this.#i)throw new Error("Fiber is not mounted");this.#s&&u(this.#s),this.#u.forEach(e=>e()),this.#s=null,this.#c=null,this.#i=!1,this.#u=[]}#f(){if(!this.#i)throw new Error("Fiber is not mounted");const e=this.render();this.#s&&this.#c&&(this.#s=A(this.#s,e,this.#c,this))}#m(e,t){return this.#d.subscribe(e,e=>{this.#a?t.call(this.#a,e):t(e)})}#h(){this.#u=Object.entries(this.#l).map(([e,t])=>this.#m(e,t))}}for(const e in i){if(g(s,e))throw new Error(`Method ${e} already exists in the component.`);s.prototype[e]=i[e]}return s}export{M as createApp,o as createElement,L as createFiber};
//# sourceMappingURL=listenjs.js.map
