function e(e,n,t){return t.addEventListener(e,n),n}var n,t;function r(e){const{type:t}=e;switch(t){case n.TEXT:!function(e){const{domElement:n}=e;n&&n.remove()}(e);break;case n.ELEMENT:!function(e){const{domElement:n,children:t,listeners:o}=e;if(!n)return;n.remove(),t.forEach(r),o&&(!function(e={},n){Object.entries(e).forEach(([e,t])=>{n.removeEventListener(e,t)})}(o,n),delete e.listeners)}(e);break;case n.FRAGMENT:!function(e){const{children:n}=e;n.forEach(r)}(e);break;default:throw new Error("Cannot destroy DOM of type: ",t)}delete e.domElement}!function(e){e[e.TEXT=Node.TEXT_NODE]="TEXT",e[e.ELEMENT=Node.ELEMENT_NODE]="ELEMENT",e[e.FRAGMENT=Node.DOCUMENT_FRAGMENT_NODE]="FRAGMENT"}(n||(n={})),function(e){e.ADD="add",e.REMOVE="remove",e.MOVE="move",e.NOOP="noop"}(t||(t={}));class o{#e=new Map;#n=[];subscribe(e,n){this.#e.has(e)||this.#e.set(e,[]);const t=this.#e.get(e);return t?.includes(n)?()=>{}:(t?.push(n),()=>{if(t){const e=t?.indexOf(n);t?.splice(e,1)}})}afterEveryCommand(e){return this.#n.push(e),()=>{const n=this.#n.indexOf(e);this.#n.splice(n,1)}}dispatch(e,n){this.#e.has(e)?this.#e.get(e)?.forEach(e=>e(n)):console.warn(`No handlers found for command: ${e}`),this.#n.forEach(e=>e())}}function i(e,n){const{class:t,style:r,...o}=n;("string"==typeof t||Array.isArray(t))&&function(e,n){e.className="","string"==typeof n&&(e.className=n);Array.isArray(n)&&e.classList.add(...n)}(e,t),r&&Object.entries(r).forEach(([n,t])=>{"string"==typeof t&&s(e,n,t)});for(const[n,t]of Object.entries(o))"string"==typeof t&&a(e,n,t)}function s(e,n,t){e.style[n]=t}function c(e,n){e.style[n]=null}function a(e,n,t){null==t?l(e,n):n.startsWith("data-")?e.setAttribute(n,String(t)):e[n]=t}function l(e,n){e[n]=null,e.removeAttribute(n)}function d(t,r,o=null){if(null==r)throw new Error(`\n      "Parent element is not defined: ${r}`);switch(t.type){case n.TEXT:!function(e,n,t){const{value:r}=e,o=document.createTextNode(r);e.domElement=o,f(o,n,t)}(t,r,o);break;case n.ELEMENT:!function(n,t,r){const{tag:o,props:s,children:c}=n,a=document.createElement(o);(function(n,t,r){const{on:o,...s}=t;o&&(r.listeners=function(n={},t){const r={};return Object.entries(n).forEach(([n,o])=>{const i=e(n,o,t);r[n]=i}),r}(o,n));i(n,s)})(a,s,n),n.domElement=a,c.forEach(e=>{d(e,a)}),f(a,t,r)}(t,r,o);break;case n.FRAGMENT:!function(e,n,t){const{children:r}=e;e.domElement=n,r.forEach((e,r)=>{d(e,n,t?t+r:null)})}(t,r,o);break;default:throw new Error("Unknown fiber type")}}function f(e,n,t){if(null==t)return n.appendChild(e);if(t<0)throw new Error(`Position Index must be positive integer, but got ${t}`);const r=n.childNodes;t>=r.length?n.appendChild(e):n.insertBefore(e,r[t])}function u(e){if("children"in e){const t=[];for(const r of e.children)r.type===n.FRAGMENT?t.push(...u(r)):t.push(r);return t}return[]}function m(e,t){if(e.type===t.type&&e.type===n.ELEMENT&&t.type===n.ELEMENT){const{tag:n}=e,{tag:r}=t;return n===r}return!1}function E(e){return e.filter(e=>null!=e)}class h{#t=[];#r=[];#o;constructor(e,n){this.#t=[...e],this.#r=e.map((e,n)=>n),this.#o=n}get length(){return this.#t.length}originalIndexAt(e){return this.#r[e]}findIndexFrom(e,n){for(let t=n;t<this.length;t++)if(this.#o(e,this.#t[t]))return t;return-1}wasElementRemoved(e,n){if(e>=this.length)return!1;const t=this.#t[e];return-1===n.findIndex(e=>this.#o(t,e))}wasElementTheSame(e,n){if(e>=this.length)return!1;const t=this.#t[e],r=n[e];return this.#o(t,r)}wasElementAdded(e,n){return-1===this.findIndexFrom(e,n)}removeItemAction(e){const n={op:t.REMOVE,index:e,item:this.#t[e]};return this.#t.splice(e,1),this.#r.splice(e,1),n}noopItemAction(e){return{op:t.NOOP,originalIndex:this.originalIndexAt(e),index:e,item:this.#t[e]}}addItemAction(e,n){const r={op:t.ADD,index:n,item:e};return this.#t.splice(n,0,e),this.#r.splice(n,0,-1),r}moveItemAction(e,n){const r=this.findIndexFrom(e,n),o={op:t.MOVE,originalIndex:this.originalIndexAt(r),from:r,index:n,item:this.#t[r]},[i]=this.#t.splice(r,1);this.#t.splice(n,0,i);const[s]=this.#r.splice(r,1);return this.#r.splice(n,0,s),o}removeRestItems(e){const n=[];for(;this.length>e;)n.push(this.removeItemAction(e));return n}}function p(e,n){const t=Object.keys(e),r=Object.keys(n);return{added:r.filter(n=>!(n in e)),removed:t.filter(e=>!(e in n)),updated:r.filter(t=>t in e&&e[t]!==n[t])}}function g(e){return function(e){return""!==e}(e.trim())}function y(o,i,f){if(console.log("Old fiber:",o),console.log("New fiber:",i),console.log("Are fibers equal?",m(o,i)),!m(o,i)){console.log("Fibers are different - replacing");const e=o.domElement?function(e,n){const t=Array.from(e.childNodes).indexOf(n);if(t<0)return null;return t}(f,o.domElement):void 0;return r(o),d(i,f,e),i}switch(i.domElement=o.domElement,i.type){case n.TEXT:return o.type===n.TEXT&&function(e,n){if(!e.domElement)throw new Error(`Cannot find DOM Element for old fiber: ${e}`);const t=e.domElement,{value:r}=e,{value:o}=n;r!==o&&(t.nodeValue=o)}(o,i),i;case n.ELEMENT:o.type===n.ELEMENT&&function(n,t){if(!n.domElement)throw new Error(`Cannot find DOM Element for old fiber: ${n}`);const r=n.domElement,{class:o,style:i,on:d,...f}=n.props,{class:u,style:m,on:E,...h}=t.props,{listeners:y}=n;function T(e,n,t){const{added:r,removed:o,updated:i}=p(n,t);for(const n of o)l(e,n);for(const n of r.concat(i))a(e,n,t[n])}function b(e,n,t){const r=l(n),o=l(t),{added:i,removed:s}=(c=r,{added:(a=o).filter(e=>!c.includes(e)),removed:c.filter(e=>!a.includes(e))});var c,a;function l(e=""){return Array.isArray(e)?e.filter(g):e.split(/(\s+)/).filter(g)}s.length>0&&e.classList.remove(...s),i.length>0&&e.classList.add(...i)}function v(e,n={},t={}){const{added:r,removed:o,updated:i}=p(n,t);for(const n of o)c(e,n);for(const n of r.concat(i))s(e,n,t[n])}function N(n,t={},r={},o={}){const{added:i,removed:s,updated:c}=p(r,o);for(const e of s.concat(c))n.removeEventListener(e,t[e]);const a={};for(const t of i.concat(c))a[t]=e(t,o[t],n);return a}T(r,f,h),b(r,o,u),v(r,i,m),t.listeners=N(r,y,d,E)}(o,i)}return function(e,n){if(!e.domElement)throw new Error(`Cannot find DOM Element for old fiber: ${e}`);console.log("Patching children...");const o=u(e),i=u(n),s=e.domElement,c=function(e,n,t=(e,n)=>e===n){const r=[],o=new h(e,t);for(let e=0;e<n.length;e++){if(o.wasElementRemoved(e,n)){r.push(o.removeItemAction(e)),e--;continue}if(o.wasElementTheSame(e,n)){r.push(o.noopItemAction(e));continue}const t=n[e];o.wasElementAdded(t,e)?r.push(o.addItemAction(t,e)):r.push(o.moveItemAction(t,e))}return r.push(...o.removeRestItems(n.length)),r}(o,i,m);console.log("Diff sequence:",c);for(const n of c){const{index:c,item:a,op:l}=n;switch(l){case t.ADD:s instanceof HTMLElement&&d(a,s,c);break;case t.REMOVE:r(a);break;case t.MOVE:if(s instanceof HTMLElement&&"originalIndex"in n){const t=o[n.originalIndex],r=i[c];if(!t.domElement)throw new Error(`Cannot find DOM Element for old fiber: ${e}`);const a=t.domElement,l=s.childNodes[c];s.insertBefore(a,l),y(t,r,s)}break;case t.NOOP:s instanceof HTMLElement&&"originalIndex"in n&&y(o[n.originalIndex],i[c],s)}}}(o,i),i}function T({state:e,view:n,reducers:t={}}){let i=null,s=null;const c=new o,a=[c.afterEveryCommand(function(){const t=n(e,l);s&&i&&(console.log("Patching DOM..."),s=y(s,t,i))})];function l(e,n={}){c.dispatch(e,n)}for(const n in t){const r=t[n],o=c.subscribe(n,n=>{e=r(e,n)});a.push(o)}return{mount(t){i=t,s=n(e,l),s&&i&&d(s,i)},unmount(){s&&r(s),s=null,a.forEach(e=>e())}}}function b(e,t={},r=[]){return{type:n.ELEMENT,tag:e,props:t,children:v(E(r))}}function v(e){return e.map(e=>{return"string"==typeof e?(t=e,{type:n.TEXT,value:t}):e;var t})}export{T as createApp,b as createFiber};
//# sourceMappingURL=listenjs.js.map
